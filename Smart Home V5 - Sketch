#include <WiFiS3.h>
#include <WiFiServer.h>

const char* ssid = "Home_Mesh_06"; // Substitua pelo nome da sua rede Wi-Fi
const char* password = "taystrOrbi"; // Substitua pela senha da sua rede Wi-Fi

WiFiServer server(80);

//INICIO VARIAVEIS DO PROJETO

const int luz_area = 0; // LED conectado à porta 0
const int botao_luz_area = 13; //botao fisico luz area
const int luz_jardim = 1; // LED conectado à porta 1
const int fita_led = 2; // LED conectado à porta 2

bool luzareaState = false; // Estado inicial do LED
bool luzjardimState = false; // Estado inicial do LED
bool fitaledState = false; // Estado inicial do LED

//FIM VARIAVEIS DO PROJETO

void setup() {

    // INICIALIZACAO DAS VARIAVEIS
    
    pinMode(luz_area, OUTPUT);
    digitalWrite(luz_area, LOW);
    
    //botao fisico
    pinMode(botao_luz_area, INPUT_PULLUP); // Configura o botão com pull-up interno

    pinMode(luz_jardim, OUTPUT);
    digitalWrite(luz_jardim, LOW);

    pinMode(fita_led, OUTPUT);
    digitalWrite(fita_led, LOW);
    

    // FIM INICIALIZACAO DAS VARIAVEIS

    Serial.begin(115200);
    WiFi.begin(ssid, password);

    Serial.print("Conectando ao Wi-Fi");
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }
    Serial.println("\nConectado ao Wi-Fi!");
    Serial.print("Endereço IP: ");
    Serial.println(WiFi.localIP());

    server.begin();
}

void loop() {


    if (digitalRead(botao_luz_area) == LOW) { // Se botão pressionado
        delay(50); // Debounce simples
        if (digitalRead(botao_luz_area) == LOW) { // Confirma pressionado
            luzareaState = !luzareaState; // Alterna o estado
            digitalWrite(luz_area, luzareaState ? HIGH : LOW);
            delay(300); // Evita múltiplos toggles muito rápidos
        }
    }

    // Lida com conexões do cliente
    WiFiClient client = server.available();
    if (client) {
        Serial.println("Cliente conectado!");
        String request = client.readStringUntil('\r');
        Serial.println(request);
        client.flush();

        // INICIO VERIFICACAO DO COMANDO DO CLIENTE

            //BOTAO LUZ AREA
            if (request.indexOf("/LuzArea_Toggle") != -1) {
                luzareaState = !luzareaState; // Alterna o estado do LED
                digitalWrite(luz_area, luzareaState ? HIGH : LOW);
                // Redireciona para a página principal
                client.println("HTTP/1.1 303 See Other");
                client.println("Location: /");
                client.println("Connection: close");
                client.println("Content-Length: 0");
                client.println();
                return; // Finaliza a conexão após o redirecionamento
            }  // FIM BOTAO LUZ AREA

            //BOTAO LUZ JARDIM
            if (request.indexOf("/LuzJardim_Toggle") != -1) {
                luzjardimState = !luzjardimState; // Alterna o estado do LED
                digitalWrite(luz_jardim, luzjardimState ? HIGH : LOW);
                // Redireciona para a página principal
                client.println("HTTP/1.1 303 See Other");
                client.println("Location: /");
                client.println("Connection: close");
                client.println("Content-Length: 0");
                client.println();
                return; // Finaliza a conexão após o redirecionamento
            }  // FIM BOTAO LUZ AREA

            //BOTAO FITA LED
            if (request.indexOf("/FitaLed_Toggle") != -1) {
                fitaledState = !fitaledState; // Alterna o estado do LED
                digitalWrite(fita_led, fitaledState ? HIGH : LOW);
                // Redireciona para a página principal
                client.println("HTTP/1.1 303 See Other");
                client.println("Location: /");
                client.println("Connection: close");
                client.println("Content-Length: 0");
                client.println();
                return; // Finaliza a conexão após o redirecionamento
            }  // FIM BOTAO FITA LED


            
        // FIM VERIFICACAO DO COMANDO DO CLIENTE


        // Responde ao cliente
        client.println("HTTP/1.1 200 OK");
        client.println("Content-Type: text/html; charset=UTF-8");
        client.println();
        client.println("<!DOCTYPE HTML>");
        client.println("<html>");
        client.println("<head>");
        client.println("<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">");

        // Meta tag para auto-refresh a cada 3 segundos (3000 ms)
        // client.println("<meta http-equiv=\"refresh\" content=\"3\">");

        // JAVASCRIPT PARA RECARREGAR A PAGINA AO RESTAURAR A ABA
        client.println("<script>");
        client.println("document.addEventListener('visibilitychange', function() {");
        client.println("    if (document.visibilityState === 'visible') {");
        client.println("        location.reload();");  // Recarrega a página quando a aba for restaurada
        client.println("    }");
        client.println("});");
        client.println("</script>");
        // FIM JAVASCRIPT 

        client.println("<style>");
        client.println("body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: linear-gradient(135deg, #f4f4f4, #e0e0e0); color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; }");
        client.println(".container { width: 90%; max-width: 300px; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; top: -10%; }");
        client.println("body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: linear-gradient(135deg,rgb(2, 192, 255), #ffffff); color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; }");
        client.println("h1 { font-size: 1.2em; margin-bottom: 15px; }");
        client.println(".toggle { display: inline-block; padding: 8px 16px; background: #007BFF; color: #fff; text-decoration: none; border-radius: 5px; font-size: 0.9em; margin-bottom: 5px; }");
        client.println(".toggle:hover { background: #0056b3; }");
        client.println(".status { font-size: 0.8em; color: #555; margin-top: 5px; }");
        client.println("</style>");
        client.println("</head>");
        client.println("<body>");
        client.println("<div class=\"container\">");
        client.println("<h1>Controle do LED</h1>");

        client.println("<br> ");
        
        // INICIO BOTAO LUZ AREA
        client.println(luzareaState 
            ? "<a href=\"/LuzArea_Toggle\" class=\"toggle\" style=\"background:rgb(133, 0, 0); width: 50%; display: inline-block; text-align: center;\">Luz Area</a><p class=\"status\">Luz Area está <strong>LIGADA</strong></p>" 
            : "<a href=\"/LuzArea_Toggle\" class=\"toggle\" style=\"background:rgb(0, 63, 0); width: 50%; display: inline-block; text-align: center;\">Luz Area</a><p class=\"status\">Luz Area está <strong>DESLIGADA</strong></p>");
        // FIM BOTAO LUZ AREA
        
        client.println("<br> ");
        
        // INICIO BOTAO LUZ JARDIM
        client.println(luzjardimState 
            ? "<a href=\"/LuzJardim_Toggle\" class=\"toggle\" style=\"background:rgb(133, 0, 0); width: 50%; display: inline-block; text-align: center;\">Luz Jardim</a><p class=\"status\">Luz Jardim está <strong>LIGADA</strong></p>" 
            : "<a href=\"/LuzJardim_Toggle\" class=\"toggle\" style=\"background:rgb(0, 63, 0); width: 50%; display: inline-block; text-align: center;\">Luz Jardim</a><p class=\"status\">Luz Jardim está <strong>DESLIGADA</strong></p>");
        // FIM BOTAO LUZ JARDIM

        client.println("<br> ");

        // INICIO BOTAO FITA LED
        client.println(fitaledState 
            ? "<a href=\"/FitaLed_Toggle\" class=\"toggle\" style=\"background:rgb(133, 0, 0); width: 50%; display: inline-block; text-align: center;\">Fita LED</a><p class=\"status\">Fita LED está <strong>LIGADA</strong></p>" 
            : "<a href=\"/FitaLed_Toggle\" class=\"toggle\" style=\"background:rgb(0, 63, 0); width: 50%; display: inline-block; text-align: center;\">Fita LED</a><p class=\"status\">Fita LED está <strong>DESLIGADA</strong></p>");
        // FIM BOTAO FITA LED


        client.println("</div>");
        client.println("</body>");
        client.println("</html>");
        client.stop();
        Serial.println("Cliente desconectado.");
    }
}
